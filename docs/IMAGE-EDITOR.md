# Image Editor 技术规格文档

## 概述

本文档描述了图片编辑器功能的技术规格，该编辑器允许用户上传图片后在全屏浮窗中进行涂抹标记，并调用 AI 接口移除标记区域的内容。

---

## 功能需求

### 核心功能

| 功能 | 描述 |
|------|------|
| 全屏编辑器 | 用户上传图片后，以全屏浮窗形式进入编辑状态，不跳转页面 |
| 画布 | 使用 react-konva 实现，展示用户图片，支持缩放 |
| 画笔工具 | 默认选中，颜色 #FF007A，透明度 50%（固定），画笔大小可调 |
| 橡皮擦工具 | 擦除涂抹区域 |
| 移除功能 | 将涂抹后的图片（原图 + mask）发送后端，生成结果覆盖当前图片 |
| Chat 工具 | 输入 prompt 进行 AI 图片编辑 |
| Undo/Redo | 针对图片生成历史的版本切换 |
| 下载 | 下载当前图片 |
| Debug 模式 | 实时预览提交给后端的 mask 图 |
| 移动端适配 | 响应式布局，触摸手势支持 |

### 用户流程

```
用户上传图片
    ↓
打开 ImageEditorDialog（全屏浮窗）
    ↓
用户使用 Brush 涂抹要移除的区域
    ↓
点击"移除"按钮
    ↓
合成 mask 图片（涂抹区域白色，其余黑色）
    ↓
调用后端 API（原图 + mask）
    ↓
返回结果图片，覆盖画布上的图片
    ↓
用户可继续编辑或下载
```

---

## 设计决策

| 项目 | 决策 | 说明 |
|------|------|------|
| 全屏样式 | 真正全屏 (100vw × 100vh) | 无边距，沉浸式编辑体验 |
| 工具栏位置 | 底部固定 | Desktop 和 Mobile 统一在底部 |
| 移动端工具栏 | 底部水平排列 | 符合移动端操作习惯 |
| 橡皮擦实现 | compositeOperation 直接擦除 | 体验更流畅 |
| Undo/Redo 范围 | 仅针对图片版本 | 不包含涂抹操作历史 |
| Debug 预览位置 | 右下角小窗口 | 实时预览，不干扰主画布 |
| 退出按钮位置 | 右上角 | 符合常见 UI 模式 |
| Chat 输入框位置 | 工具栏上方 | 点击 Chat 工具时显示 |
| 后端服务 | Mock 接口 | 预留真实接口接入点 |

---

## 界面布局

### Desktop 布局 (≥768px)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                         ┌───┐   ┌───┐  │
│                                                         │🔧 │   │ ✕ │  │
│                                                         └───┘   └───┘  │
│                                                        Debug    退出   │
│                                                                         │
│                                                                         │
│                                                                         │
│                     ┌───────────────────────────────┐                   │
│                     │                               │                   │
│                     │                               │                   │
│                     │                               │                   │
│                     │                               │                   │
│                     │       用户上传的图片           │                   │
│                     │       (可缩放/拖动)            │                   │
│                     │                               │                   │
│                     │                               │                   │
│                     │                               │                   │
│                     │                               │       ┌─────────┐ │
│                     │                               │       │  Mask   │ │
│                     └───────────────────────────────┘       │ Preview │ │
│                                                             │ (Debug) │ │
│                                                             └─────────┘ │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │   ○──────────────────●─────────────────○   Brush Size             │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  🖌️  │  🧹  │  💬  │  ↩️  │  ↪️  │  ⬇️  │              │   移除   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Desktop - Chat 激活状态

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                         ┌───┐   ┌───┐  │
│                                                         │🔧 │   │ ✕ │  │
│                                                         └───┘   └───┘  │
│                                                                         │
│                     ┌───────────────────────────────┐                   │
│                     │                               │                   │
│                     │                               │                   │
│                     │       用户上传的图片           │                   │
│                     │       (可缩放/拖动)            │                   │
│                     │                               │                   │
│                     │                               │       ┌─────────┐ │
│                     │                               │       │  Mask   │ │
│                     └───────────────────────────────┘       │ (Debug) │ │
│                                                             └─────────┘ │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 💬 描述你想要的修改...                                     [发送] │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                        ↑ Chat 输入框 (工具栏上方)                        │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  🖌️  │  🧹  │  💬  │  ↩️  │  ↪️  │  ⬇️  │              │   移除   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                  ↑ 💬 高亮状态                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Mobile 布局 (<768px)

```
┌────────────────────────────────┐
│                    ┌───┐ ┌───┐ │
│                    │🔧 │ │ ✕ │ │
│                    └───┘ └───┘ │
│                   Debug  退出  │
│                                │
│ ┌────────────────────────────┐ │
│ │                            │ │
│ │                            │ │
│ │                            │ │
│ │      用户上传的图片         │ │
│ │      (可缩放/拖动)          │ │
│ │                            │ │
│ │                            │ │
│ │                   ┌──────┐ │ │
│ │                   │ Mask │ │ │
│ └───────────────────┴──────┘ │ │
│                                │
│ ┌────────────────────────────┐ │
│ │  ○───────────●──────○      │ │
│ │       Brush Size           │ │
│ └────────────────────────────┘ │
│                                │
│ ┌────────────────────────────┐ │
│ │ 🖌️ │ 🧹 │ 💬 │ ↩️ │ ↪️ │ ⬇️  │ │
│ └────────────────────────────┘ │
│                                │
│ ┌────────────────────────────┐ │
│ │          移除              │ │
│ └────────────────────────────┘ │
└────────────────────────────────┘
```

### Mobile - Chat 激活状态

```
┌────────────────────────────────┐
│                    ┌───┐ ┌───┐ │
│                    │🔧 │ │ ✕ │ │
│                    └───┘ └───┘ │
│                                │
│ ┌────────────────────────────┐ │
│ │                            │ │
│ │      用户上传的图片         │ │
│ │      (可缩放/拖动)          │ │
│ │                   ┌──────┐ │ │
│ │                   │ Mask │ │ │
│ └───────────────────┴──────┘ │ │
│                                │
│ ┌────────────────────────────┐ │
│ │ 💬 描述你想要的修改...      │ │
│ │                    [发送]  │ │
│ └────────────────────────────┘ │
│       ↑ Chat 输入框            │
│                                │
│ ┌────────────────────────────┐ │
│ │ 🖌️ │ 🧹 │ 💬 │ ↩️ │ ↪️ │ ⬇️  │ │
│ └────────────────────────────┘ │
│                                │
│ ┌────────────────────────────┐ │
│ │          移除              │ │
└────────────────────────────────┘
```

---

## 底部区域层级结构

从下往上的堆叠顺序：

```
┌─────────────────────────────────────────┐
│              移除按钮                    │  ← 最底层，始终可见
├─────────────────────────────────────────┤
│  🖌️ │ 🧹 │ 💬 │ ↩️ │ ↪️ │ ⬇️             │  ← 工具栏，始终可见
├─────────────────────────────────────────┤
│  Chat 输入框 (点击💬时显示/隐藏)         │  ← 条件显示
├─────────────────────────────────────────┤
│  Brush Size 滑块                        │  ← 选中 Brush/Eraser 时显示
└─────────────────────────────────────────┘
```

**交互逻辑**：
- 选中 Brush/Eraser → 显示 Brush Size 滑块
- 点击 Chat → 显示 Chat 输入框，隐藏 Brush Size 滑块
- 再次点击 Chat 或点击其他工具 → 隐藏 Chat 输入框

---

## 工具栏设计

### 工具栏布局

```
┌──────┬──────┬──────┬──────┬──────┬──────┬──────────────┬─────────────┐
│  🖌️  │  🧹  │  💬  │  ↩️  │  ↪️  │  ⬇️  │              │    移除     │
│Brush │Eraser│ Chat │ Undo │ Redo │ Down │   (空白)     │   Button    │
└──────┴──────┴──────┴──────┴──────┴──────┴──────────────┴─────────────┘
   ↑                                            ↑              ↑
 左侧工具组                                  flex-grow       右侧固定
 (均分或固定宽度)                            撑开间距         突出显示
```

**移动端**：移除按钮独立一行，工具图标均分宽度

### 工具状态

| 图标 | 工具 | 默认状态 | 激活状态 | 禁用状态 |
|------|------|----------|----------|----------|
| 🖌️ | Brush | 灰色 | 主色高亮+背景 | - |
| 🧹 | Eraser | 灰色 | 主色高亮+背景 | 无涂抹时禁用 |
| 💬 | Chat | 灰色 | 主色高亮+背景 | 处理中禁用 |
| ↩️ | Undo | 灰色 | 可点击 | 无历史时禁用 |
| ↪️ | Redo | 灰色 | 可点击 | 无前进历史时禁用 |
| ⬇️ | Download | 灰色 | hover 高亮 | - |
| ✕ | 退出 | 灰色 | hover 高亮 | - |
| 🔧 | Debug | 灰色 | 开启时高亮 | - |

### 移除按钮状态

```
无涂抹时:
┌─────────────────────────────┐
│         移除               │  ← 灰色背景，disabled
└─────────────────────────────┘

有涂抹时:
┌─────────────────────────────┐
│         移除               │  ← 主色背景 (#FF007A)，可点击
└─────────────────────────────┘

处理中:
┌─────────────────────────────┐
│     ○ 处理中...            │  ← 主色背景，loading spinner
└─────────────────────────────┘
```

---

## Debug 预览窗口

```
┌─────────────────┐
│ ■■■■■■■■■■■■■■■ │  ← 黑色背景 (保留区域)
│ ■■■■■███■■■■■■ │
│ ■■■■████████■■ │  ← 白色区域 (涂抹区域，即要移除的部分)
│ ■■■■■███■■■■■■ │
│ ■■■■■■■■■■■■■■■ │
└─────────────────┘
  约 120×120px
  右下角固定位置
  仅在 Debug 模式开启时显示
```

---

## 画布设计 (react-konva)

### 图层结构

```
Stage (可缩放)
  └── Layer
        ├── Image (用户图片)
        └── Line[] (涂抹笔画，#FF007A 50% 透明度)
```

### 缩放方案

- 使用 Konva 的 `stage.scale()` 配合鼠标滚轮/双指缩放
- 移动端：双指捏合缩放
- 保持图片居中，限制最小/最大缩放比例 (0.1x - 5x)

### 画笔参数

| 参数 | 值 |
|------|------|
| 颜色 | #FF007A |
| 透明度 | 50% (0.5) |
| 默认大小 | 20px |
| 大小范围 | 5px - 100px |
| lineCap | round |
| lineJoin | round |

### 触摸支持

- 单指：绘制
- 双指：缩放/平移（需区分绘制和缩放手势）

---

## 组件架构

### 文件结构

```
src/components/image-editor/
├── ImageEditorDialog.tsx      # 全屏 Dialog 容器
├── EditorCanvas.tsx           # Konva 画布
├── EditorToolbar.tsx          # 工具栏 (响应式)
├── BrushSizeSlider.tsx        # 画笔大小滑块
├── ChatPanel.tsx              # Chat 输入面板
├── DebugPreview.tsx           # Debug mask 预览
├── RemoveButton.tsx           # 移除按钮
├── hooks/
│   ├── use-editor-state.ts    # 编辑器状态
│   ├── use-drawing.ts         # 涂抹逻辑
│   └── use-image-history.ts   # 图片版本历史
├── lib/
│   └── mask-generator.ts      # 将涂抹转为黑白 mask
└── types.ts
```

### 组件职责

| 组件 | 职责 |
|------|------|
| `ImageEditorDialog` | 全屏容器，管理打开/关闭状态，布局协调 |
| `EditorCanvas` | Konva Stage/Layer，图片渲染，涂抹绑定，缩放控制 |
| `EditorToolbar` | 工具按钮组，响应式布局 |
| `BrushSizeSlider` | 滑块控件，调整画笔大小 |
| `ChatPanel` | 输入框 + 发送按钮 |
| `DebugPreview` | 实时渲染 mask 缩略图 |
| `RemoveButton` | 移除按钮，状态管理 |

---

## 状态管理

### EditorState (use-editor-state hook)

```typescript
interface EditorState {
  // 编辑器状态
  isOpen: boolean
  originalImage: string | null      // 原始上传图片
  currentImage: string | null       // 当前显示图片

  // 工具状态
  activeTool: 'brush' | 'eraser' | 'chat'
  brushSize: number                 // 默认 20，范围 5-100

  // 涂抹状态
  lines: Line[]                     // 每条 line 包含 points 数组
  hasMask: boolean                  // 是否有涂抹，控制移除按钮高亮

  // 历史状态（图片版本）
  imageHistory: string[]            // 图片版本数组
  historyIndex: number              // 当前版本索引

  // Debug
  debugMode: boolean

  // 加载状态
  isProcessing: boolean
}

interface Line {
  points: number[]                  // [x1, y1, x2, y2, ...]
  strokeWidth: number
  isEraser: boolean                 // true 时使用 destination-out
}
```

### Actions

```typescript
interface EditorActions {
  // 编辑器控制
  openEditor: (image: string) => void
  closeEditor: () => void

  // 工具切换
  setActiveTool: (tool: 'brush' | 'eraser' | 'chat') => void
  setBrushSize: (size: number) => void

  // 涂抹操作
  addLine: (line: Line) => void
  clearLines: () => void

  // 图片历史
  pushImageHistory: (image: string) => void
  undo: () => void
  redo: () => void

  // Debug
  toggleDebugMode: () => void

  // 处理状态
  setProcessing: (isProcessing: boolean) => void
}
```

---

## API 设计

### Inpaint API (Mock)

```typescript
// POST /api/image-edit/inpaint
// 移除涂抹区域

interface InpaintRequest {
  image: string       // base64 原图
  mask: string        // base64 mask (白色=移除区域，黑色=保留区域)
}

interface InpaintResponse {
  image: string       // base64 结果图
}

// Mock 实现：直接返回原图
```

### Chat Edit API (Mock)

```typescript
// POST /api/image-edit/chat
// 根据 prompt 编辑图片

interface ChatEditRequest {
  image: string       // base64 原图
  prompt: string      // 用户输入的编辑指令
}

interface ChatEditResponse {
  image: string       // base64 结果图
}

// Mock 实现：直接返回原图
```

---

## 依赖

### 新增依赖

```bash
pnpm add react-konva konva
```

### 现有可复用依赖

- `@radix-ui/react-dialog` - 弹窗基础
- `@radix-ui/react-slider` - 滑块控件
- `lucide-react` - 图标
- `react-dropzone` - 文件上传（已有）
- `zustand` - 状态管理（可选）

---

## 国际化

需要在 `messages/en.json` 和 `messages/zh.json` 中添加以下翻译：

```json
{
  "ImageEditor": {
    "title": "Edit Image",
    "tools": {
      "brush": "Brush",
      "eraser": "Eraser",
      "chat": "Chat",
      "undo": "Undo",
      "redo": "Redo",
      "download": "Download"
    },
    "brushSize": "Brush Size",
    "remove": "Remove",
    "removing": "Removing...",
    "close": "Close",
    "debug": "Debug",
    "chatPlaceholder": "Describe the changes you want..."
  }
}
```

---

## 实现注意事项

1. **Konva 与 Next.js SSR**：react-konva 不支持 SSR，需要动态导入或确保只在客户端渲染

2. **图片跨域**：如果图片来自外部源，需要处理 CORS 以便 canvas 导出

3. **性能优化**：
   - 大图片需要在上传时压缩
   - 涂抹 lines 过多时考虑合并到单个 canvas

4. **触摸手势区分**：需要正确区分单指绘制和双指缩放，避免冲突

5. **Mask 生成**：将彩色涂抹转换为黑白 mask 时，需要创建临时 canvas
